<?xml version="1.0" encoding="UTF-8"?>

<!--
  ~ Copyright 2015 Kaiserpfalz EDV-Service, Roland T. Lichti
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="
            http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        ">
    <changeSet id="kpo-financialaccounting-store-inititial" author="klenkes74">
        <comment>The accounting tables.</comment>

        <createTable schemaName="accounting" tableName="accounts">
            <column name="id_" type="VARCHAR2(50)">
                <constraints primaryKey="true" primaryKeyName="accounts_ok"/>
            </column>
            <column name="tenant_" type="VARCHAR2(50)">
                <constraints nullable="false"/>
            </column>

            <column name="display_name_" type="VARCHAR2(100)"/>
            <column name="display_number_" type="VARCHAR2(100)"/>
            <column name="hidden_" type="BOOLEAN"/>
        </createTable>

        <createTable schemaName="accounting" tableName="account_mappings">
            <column name="id_" type="VARCHAR2(50)">
                <constraints primaryKey="true" primaryKeyName="account_mappings_pk"/>
            </column>
            <column name="tenant_" type="VARCHAR2(50)">
                <constraints nullable="false"/>
            </column>

            <column name="display_name_" type="VARCHAR2(100)"/>
            <column name="display_number_" type="VARCHAR2(100)"/>
            <column name="hidden_" type="BOOLEAN"/>
        </createTable>

        <createTable schemaName="accounting" tableName="account_mapping_rules">
            <column name="id_" type="VARCHAR2(50)">
                <constraints primaryKey="true" primaryKeyName="account_mapping_rules_pk"/>
            </column>

            <column name="account_mappings_" type="VARCHAR2(50)">
                <constraints foreignKeyName="account_mapping_rules_mapping_fk" references="account_mappings(id_)"/>
            </column>
            <column name="account_" type="VARCHAR2(50)">
                <constraints foreignKeyName="account_mapping_rules_account_fk" references="accounts(id_)"/>
            </column>
            <column name="number_" type="VARCHAR2(200)"/>
        </createTable>

        <createTable schemaName="accounting" tableName="primanota">
            <column name="id_" type="VARCHAR2(50)">
                <constraints primaryKey="true" primaryKeyName="primanota_pk"/>
            </column>
            <column name="tenant_" type="VARCHAR2(50)">
                <constraints nullable="false"/>
            </column>

            <column name="display_name_" type="VARCHAR2(100)"/>
            <column name="display_number_" type="VARCHAR2(100)"/>
            <column name="hidden_" type="BOOLEAN"/>
        </createTable>

        <createTable schemaName="accounting" tableName="primanota_entries">
            <column name="id_" type="VARCHAR2(50)">
                <constraints primaryKey="true" primaryKeyName="primanota_entries_pk"/>
            </column>
            <column name="hidden_" type="BOOLEAN"/>


            <column name="entry_id_" type="BIGINT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="timestamp_entry_" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="date_accounting_" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="date_valuta_" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="entry_amount_value_" type="DECIMAL(14.5)" defaultValueNumeric="0.0000">
                <constraints nullable="false"/>
            </column>
            <column name="entry_amount_currency_" type="VARCHAR2(5)" defaultValue="EUR">
                <constraints nullable="false"/>
            </column>


            <column name="documentId" type="VARCHAR2(100)">
                <constraints nullable="false"/>
            </column>
            <column name="document_date_" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="document_amount_value_" type="DECIMAL(14.5)" defaultValueNumeric="0.0000">
                <constraints nullable="false"/>
            </column>
            <column name="document_amount_currency_" type="VARCHAR2(5)" defaultValue="EUR">
                <constraints nullable="false"/>
            </column>

            <column name="notice_" type="VARCHAR2(255)"/>

            <column name="account_debitted_" type="VARCHAR2(50)">
                <constraints nullable="false" foreignKeyName="primanota_debitted_fk" references="accounts(id_)"/>
            </column>
            <column name="account_creditted_" type="VARCHAR2(50)">
                <constraints nullable="false" foreignKeyName="primanota_creditted_fk" references="accounts(id_)"/>
            </column>

            <column name="primanota_" type="VARCHAR2(50)">
                <constraints foreignKeyName="primanota_entries_primanota_fk" references="primanota(id_)"/>
            </column>
        </createTable>


        <createIndex schemaName="accounting" tableName="accounts" indexName="accounts_number_uk" unique="true">
            <column name="tenant_"/>
            <column name="display_number_"/>
        </createIndex>

        <createIndex schemaName="accounting" tableName="account_mappings" indexName="account_mapping_name_uk"
                     unique="true">
            <column name="tenant_"/>
            <column name="display_name_"/>
        </createIndex>

        <createIndex schemaName="accounting" tableName="account_mappings" indexName="account_mapping_number_uk"
                     unique="true">
            <column name="tenant_"/>
            <column name="display_number_"/>
        </createIndex>

        <createIndex schemaName="accounting" tableName="account_mapping_rules" indexName="account_mapping_rules_uk"
                     unique="true">
            <column name="account_mappings_"/>
            <column name="account_"/>
            <column name="number_"/>
        </createIndex>

        <createIndex schemaName="accounting" tableName="primanota" indexName="primanote_name_uk" unique="true">
            <column name="tenant_"/>
            <column name="display_name_"/>
        </createIndex>

        <createIndex schemaName="accounting" tableName="primanota" indexName="primanota_number_uk" unique="true">
            <column name="tenant_"/>
            <column name="display_number_"/>
        </createIndex>
    </changeSet>

    <changeSet id="kpo-financialaccounting-load-initial" author="klenkes74">
        <comment>Load default chart of account and mappings.</comment>

        <loadData schemaName="accounting" tableName="accounts" file="data/ACCOUNTS-0_2_0.csv"/>
        <loadData schemaName="accounting" tableName="account_mappings" file="data/ACCOUNT_MAPPINGS-0_2_0.csv"/>
        <loadData schemaName="accounting" tableName="account_mapping_rules"
                  file="data/ACCOUNT_MAPPING_RULES-0_2_0.csv"/>
    </changeSet>


    <changeSet id="kpo-financialaccounting-tag-initial" author="klenkes74">
        <tagDatabase tag="kpo-financialaccounting-initial"/>
    </changeSet>
</databaseChangeLog>
